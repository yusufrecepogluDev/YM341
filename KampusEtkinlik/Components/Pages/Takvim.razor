@page "/takvim"
@using KampusEtkinlik.Services
@using KampusEtkinlik.Data.Models
@inject CalendarApiService CalendarService

<div class="calendar-container">
    <div class="calendar-header">
        <h1 class="calendar-title">Etkinlik Takvimi</h1>
        <p class="calendar-subtitle">Tüm kulüp etkinliklerini ve duyuruları görüntüleyin</p>
    </div>

    <!-- Ay Navigasyonu -->
    <div class="month-navigation">
        <button class="nav-btn prev-btn" @onclick="PreviousMonth" disabled="@isLoading">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        
        <h2 class="current-month">
            @currentDate.ToString("MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"))
            @if (isLoading)
            {
                <span class="loading-spinner">⏳</span>
            }
        </h2>
        
        <button class="nav-btn next-btn" @onclick="NextMonth" disabled="@isLoading">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <!-- Renk Açıklaması -->
    <div class="legend">
        <div class="legend-item">
            <span class="legend-dot activity"></span>
            <span class="legend-text">Kulüp Etkinlikleri</span>
        </div>
        <div class="legend-item">
            <span class="legend-dot announcement"></span>
            <span class="legend-text">Duyurular</span>
        </div>
        <div class="legend-item">
            <span class="legend-dot academic"></span>
            <span class="legend-text">Akademik Olaylar</span>
        </div>
    </div>

    <!-- Takvim Grid -->
    <div class="calendar-wrapper">
        <!-- Gün İsimleri -->
        <div class="weekdays">
            <div class="weekday">Pzt</div>
            <div class="weekday">Sal</div>
            <div class="weekday">Çar</div>
            <div class="weekday">Per</div>
            <div class="weekday">Cum</div>
            <div class="weekday">Cmt</div>
            <div class="weekday">Paz</div>
        </div>

        <!-- Takvim Günleri (Dinamik) -->
        <div class="calendar-grid">
            @foreach (var day in calendarDays)
            {
                <div class="day @(day.IsOtherMonth ? "other-month" : "") @(day.IsToday ? "today" : "")" 
                     title="@($"{day.Date:dd/MM/yyyy} - {day.Events.Count} etkinlik")"
                     @onclick="() => OpenDayModal(day)">
                    <span class="day-number">@day.Day</span>
                    @if (day.HasEvents)
                    {
                        <div class="event-list">
                            @{
                                var displayEvents = day.Events.Take(3).ToList();
                                var remainingCount = day.Events.Count - displayEvents.Count;
                            }
                            @foreach (var evt in displayEvents)
                            {
                                var categoryClass = evt.Categories switch
                                {
                                    "KulupEtkinligi" => "activity",
                                    "Duyuru" => "announcement",
                                    "AkademikOlay" => "academic",
                                    _ => "activity"
                                };
                                var shortTitle = evt.Title.Length > 15 ? evt.Title.Substring(0, 15) + "..." : evt.Title;
                                
                                <div class="event-item @categoryClass" title="@evt.Title">
                                    <span class="event-dot"></span>
                                    <span class="event-title">@shortTitle</span>
                                </div>
                            }
                            @if (remainingCount > 0)
                            {
                                <div class="more-events">+@remainingCount daha</div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal -->
@if (showModal && selectedDay != null)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2 class="modal-title">
                    @selectedDay.Date.ToString("dd MMMM yyyy, dddd", new System.Globalization.CultureInfo("tr-TR"))
                </h2>
                <button class="modal-close" @onclick="CloseModal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                @if (!selectedDay.HasEvents)
                {
                    <p class="no-events">Bu günde etkinlik bulunmamaktadır.</p>
                }
                else
                {
                    @* Akademik Olaylar *@
                    @if (selectedDay.Events.Any(e => e.Categories == "AkademikOlay"))
                    {
                        <div class="modal-category">
                            <h3 class="category-title academic">
                                <span class="category-dot"></span>
                                Akademik Olaylar
                            </h3>
                            @foreach (var evt in selectedDay.Events.Where(e => e.Categories == "AkademikOlay"))
                            {
                                <div class="modal-event academic">
                                    <h4 class="event-name">@evt.Title</h4>
                                    <p class="event-description">@evt.Description</p>
                                    <div class="event-meta">
                                        @if (!evt.IsAllDay)
                                        {
                                            <span class="meta-item">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                    <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                </svg>
                                                @evt.StartDate.ToString("HH:mm")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="meta-item">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                    <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                </svg>
                                                Tüm gün
                                            </span>
                                        }
                                        @if (!string.IsNullOrEmpty(evt.Location))
                                        {
                                            <span class="meta-item">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 5.02944 7.02944 1 12 1C16.9706 1 21 5.02944 21 10Z" stroke="currentColor" stroke-width="2"/>
                                                    <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                                                </svg>
                                                @evt.Location
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Kulüp Etkinlikleri *@
                    @if (selectedDay.Events.Any(e => e.Categories == "KulupEtkinligi"))
                    {
                        <div class="modal-category">
                            <h3 class="category-title activity">
                                <span class="category-dot"></span>
                                Kulüp Etkinlikleri
                            </h3>
                            @foreach (var evt in selectedDay.Events.Where(e => e.Categories == "KulupEtkinligi"))
                            {
                                <div class="modal-event activity">
                                    <h4 class="event-name">@evt.Title</h4>
                                    <p class="event-description">@evt.Description</p>
                                    <div class="event-meta">
                                        @if (!evt.IsAllDay)
                                        {
                                            <span class="meta-item">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                    <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                </svg>
                                                @evt.StartDate.ToString("HH:mm") - @evt.EndDate.ToString("HH:mm")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="meta-item">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                    <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                </svg>
                                                Tüm gün
                                            </span>
                                        }
                                        @if (!string.IsNullOrEmpty(evt.Location))
                                        {
                                            <span class="meta-item">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 5.02944 7.02944 1 12 1C16.9706 1 21 5.02944 21 10Z" stroke="currentColor" stroke-width="2"/>
                                                    <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                                                </svg>
                                                @evt.Location
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Duyurular *@
                    @if (selectedDay.Events.Any(e => e.Categories == "Duyuru"))
                    {
                        <div class="modal-category">
                            <h3 class="category-title announcement">
                                <span class="category-dot"></span>
                                Duyurular
                            </h3>
                            @foreach (var evt in selectedDay.Events.Where(e => e.Categories == "Duyuru"))
                            {
                                <div class="modal-event announcement">
                                    <h4 class="event-name">@evt.Title</h4>
                                    <p class="event-description">@evt.Description</p>
                                    <div class="event-meta">
                                        @if (!string.IsNullOrEmpty(evt.Location))
                                        {
                                            <span class="meta-item">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 5.02944 7.02944 1 12 1C16.9706 1 21 5.02944 21 10Z" stroke="currentColor" stroke-width="2"/>
                                                    <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                                                </svg>
                                                @evt.Location
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}

@code {
    private DateTime currentDate = DateTime.Now;
    private List<CalendarDay> calendarDays = new();
    private List<CalendarEvent> monthEvents = new();
    private bool isLoading = false;
    private bool showModal = false;
    private CalendarDay? selectedDay = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthEvents();
        GenerateCalendar();
    }

    private async Task PreviousMonth()
    {
        currentDate = currentDate.AddMonths(-1);
        await LoadMonthEvents();
        GenerateCalendar();
    }

    private async Task NextMonth()
    {
        currentDate = currentDate.AddMonths(1);
        await LoadMonthEvents();
        GenerateCalendar();
    }

    private async Task LoadMonthEvents()
    {
        isLoading = true;
        try
        {
            var firstDay = new DateTime(currentDate.Year, currentDate.Month, 1);
            var lastDay = firstDay.AddMonths(1).AddDays(-1);
            
            monthEvents = await CalendarService.GetEventsByDateRangeAsync(firstDay, lastDay);
            Console.WriteLine($"Yüklenen etkinlik sayısı: {monthEvents.Count}");
            
            // Kategorilere göre say
            var activities = monthEvents.Count(e => e.Categories == "KulupEtkinligi");
            var announcements = monthEvents.Count(e => e.Categories == "Duyuru");
            var academic = monthEvents.Count(e => e.Categories == "AkademikOlay");
            Console.WriteLine($"Kulüp: {activities}, Duyuru: {announcements}, Akademik: {academic}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Etkinlikler yüklenirken hata: {ex.Message}");
            monthEvents = new List<CalendarEvent>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenDayModal(CalendarDay day)
    {
        if (day.IsOtherMonth) return; // Diğer ayın günlerine tıklanmasın
        
        selectedDay = day;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        selectedDay = null;
    }

    private void GenerateCalendar()
    {
        calendarDays.Clear();
        
        var firstDayOfMonth = new DateTime(currentDate.Year, currentDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        
        // Pazartesi = 1, Pazar = 0 (DayOfWeek enum'unda Pazar = 0)
        int firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
        if (firstDayOfWeek == 0) firstDayOfWeek = 7; // Pazar'ı 7 yap
        
        // Önceki aydan kaç gün göstereceğiz
        int daysFromPrevMonth = firstDayOfWeek - 1;
        
        // Önceki ayın günlerini ekle
        var prevMonthStart = firstDayOfMonth.AddDays(-daysFromPrevMonth);
        for (int i = 0; i < daysFromPrevMonth; i++)
        {
            var date = prevMonthStart.AddDays(i);
            calendarDays.Add(new CalendarDay
            {
                Date = date,
                Day = date.Day,
                IsOtherMonth = true,
                IsToday = false,
                Events = new List<CalendarEvent>()
            });
        }
        
        // Bu ayın günlerini ekle
        for (int day = 1; day <= lastDayOfMonth.Day; day++)
        {
            var date = new DateTime(currentDate.Year, currentDate.Month, day);
            
            // Başlangıç tarihi bu gün olan etkinlikler
            var startEvents = monthEvents.Where(e => e.StartDate.Date == date.Date).ToList();
            
            // Bitiş tarihi bu gün olan çok günlük etkinlikler (başlangıç tarihi farklı)
            var endEvents = monthEvents
                .Where(e => e.EndDate.Date == date.Date && e.StartDate.Date != e.EndDate.Date)
                .Select(e => new CalendarEvent
                {
                    Id = e.Id,
                    Title = e.Title + " (Bitiş Günü)",
                    Description = e.Description,
                    StartDate = e.StartDate,
                    EndDate = e.EndDate,
                    Categories = e.Categories,
                    CategoriesColor = e.CategoriesColor,
                    IsAllDay = e.IsAllDay,
                    Location = e.Location
                })
                .ToList();
            
            var dayEvents = startEvents.Concat(endEvents).ToList();
            
            calendarDays.Add(new CalendarDay
            {
                Date = date,
                Day = day,
                IsOtherMonth = false,
                IsToday = date.Date == DateTime.Today,
                Events = dayEvents
            });
        }
        
        // Sonraki aydan günler ekle (toplam 35 veya 42 gün olacak şekilde)
        int totalDays = calendarDays.Count;
        int daysToAdd = totalDays <= 35 ? 35 - totalDays : 42 - totalDays;
        
        for (int i = 1; i <= daysToAdd; i++)
        {
            var date = lastDayOfMonth.AddDays(i);
            calendarDays.Add(new CalendarDay
            {
                Date = date,
                Day = date.Day,
                IsOtherMonth = true,
                IsToday = false,
                Events = new List<CalendarEvent>()
            });
        }
    }

    private class CalendarDay
    {
        public DateTime Date { get; set; }
        public int Day { get; set; }
        public bool IsOtherMonth { get; set; }
        public bool IsToday { get; set; }
        public List<CalendarEvent> Events { get; set; } = new();
        
        // Etkinlik göstergeleri
        public bool HasActivity => Events.Any(e => e.Categories == "KulupEtkinligi");
        public bool HasAnnouncement => Events.Any(e => e.Categories == "Duyuru");
        public bool HasAcademic => Events.Any(e => e.Categories == "AkademikOlay");
        public bool HasEvents => Events.Any();
    }
}
