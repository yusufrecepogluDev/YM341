@page "/home"
@rendermode InteractiveServer
@using KampusEtkinlik.Data.Models
@using KampusEtkinlik.Services
@inject ActivityService ActivityService
@inject AnnouncementService AnnouncementService
@inject ActivityParticipationService ParticipationService
@inject RecommendationService RecommendationService
@inject TokenService TokenService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration

<main class="ana-icerik">

    @* --- KİŞİSELLEŞTİRİLMİŞ ÖNERİLER BÖLÜMÜ --- *@
    @if (isStudent && currentUserId > 0)
    {
        <section class="bolum-konteyner oneri-bolumu">
            <h2 class="baslik">🎯 Senin İçin Öneriler</h2>

            <div class="slider-wrapper">
                <button class="kaydirma-butonu sol" @onclick="() => ScrollRecommendationsLeft()">←</button>

                <div class="slider-track" @ref="oneriListesi">
                    @if (isLoadingRecommendations)
                    {
                        <div class="slider-card loading-card recommendation-card">
                            <h3>Öneriler yükleniyor...</h3>
                        </div>
                    }
                    else if (recommendedActivities == null || !recommendedActivities.Any())
                    {
                        <div class="slider-card empty-card recommendation-card">
                            <h3>Öneri Bulunamadı</h3>
                            <p>Kulüplere üye olarak kişiselleştirilmiş öneriler alabilirsiniz.</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var activity in recommendedActivities)
                        {
                            <div class="slider-card content-card recommendation-card"
                                 style="background-image: url('@GetActivityImage(activity.ImagePath)');"
                                 @onclick="() => OpenActivityPopup(activity)">
                                <div class="card-content">
                                    <div class="recommendation-badge">✨ Önerilen</div>
                                    <h3>@activity.ActivityName</h3>
                                    <div class="date-badge">
                                        📅 @activity.StartDate.ToString("dd.MM")
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <button class="kaydirma-butonu sag" @onclick="() => ScrollRecommendationsRight()">→</button>
            </div>
        </section>

        <div class="ayirici-cizgi"></div>
    }

    <section class="bolum-konteyner etkinlik-bolumu">
        <h2 class="baslik">Etkinlikler</h2>

        <div class="slider-wrapper">
            <button class="kaydirma-butonu sol" @onclick="() => ScrollActivityLeft()">←</button>

            <div class="slider-track" @ref="etkinlikListesi">
                @if (activities == null)
                {
                    <div class="slider-card loading-card">
                        <h3>Yükleniyor...</h3>
                    </div>
                }
                else if (!activities.Any())
                {
                    <div class="slider-card empty-card">
                        <h3>Etkinlik Yok</h3>
                    </div>
                }
                else
                {
                    @foreach (var activity in activities)
                    {
                        <div class="slider-card content-card"
                             style="background-image: url('@GetActivityImage(activity.ImagePath)');"
                             @onclick="() => OpenActivityPopup(activity)">
                            <div class="card-content">
                                <h3>@activity.ActivityName</h3>
                                <div class="date-badge">
                                    📅 @activity.StartDate.ToString("dd.MM")
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <button class="kaydirma-butonu sag" @onclick="() => ScrollActivityRight()">→</button>
        </div>
    </section>

    <div class="ayirici-cizgi"></div>

    <section class="bolum-konteyner duyuru-bolumu">
        <h2 class="baslik">Duyurular</h2>

        <div class="slider-wrapper">
            <button class="kaydirma-butonu sol" @onclick="() => ScrollLeft()">←</button>

            <div class="slider-track" @ref="duyuruListesi">
                @if (announcements == null)
                {
                    <article class="duyuru-karti loading">
                        <h3>Yükleniyor...</h3>
                    </article>
                }
                else if (!announcements.Any())
                {
                    <article class="duyuru-karti empty">
                        <h3>Duyuru Yok</h3>
                        <p>Güncel duyuru bulunmamaktadır.</p>
                    </article>
                }
                else
                {
                    @foreach (var (announcement, index) in announcements.Select((a, i) => (a, i)))
                    {
                        <article class="duyuru-karti @(index % 3 == 0 ? "highlight" : "")"
                                 @onclick="() => OpenAnnouncementPopup(announcement)">
                            <div class="duyuru-header">
                                <h3>@announcement.Title</h3>
                                <span class="tarih-etiketi">@announcement.CreatedAt.ToString("dd.MM")</span>
                            </div>
                            <p class="duyuru-ozet">@announcement.Content</p>
                            <div class="duyuru-footer">
                                <span>Devamını Oku →</span>
                            </div>
                        </article>
                    }
                }
            </div>

            <button class="kaydirma-butonu sag" @onclick="() => ScrollRight()">→</button>
        </div>

    </section>

</main>


@* --- POP-UP MODAL ALANI --- *@
@if (isPopupVisible)
{
    <div class="modal-overlay" @onclick="ClosePopup">
        <div class="modal-content" @onclick:stopPropagation>
            
            @if (selectedActivity != null)
            {
                <div class="modal-header">
                    <button class="modal-close-btn" @onclick="ClosePopup">×</button>
                    <h2 class="modal-title">@selectedActivity.ActivityName</h2>
                    <p class="modal-club-name">@selectedActivity.OrganizingClubName</p>
                </div>
                <div class="modal-body">
                    @* Ortalama Puan *@
                    <div class="rating-average-box">
                        <div class="rating-stars-display">
                            @for (int i = 1; i <= 5; i++)
                            {
                                var starIndex = i;
                                <span class="star-display @(starIndex <= Math.Round(averageRating) ? "filled" : "")">★</span>
                            }
                        </div>
                        <span class="rating-value">@averageRating.ToString("0.0")</span>
                        <span class="rating-count">(@ratingCount değerlendirme)</span>
                    </div>

                    <div class="modal-info-grid">
                        <div class="info-item">
                            <strong>Başlangıç</strong>
                            <span>@selectedActivity.StartDate.ToString("dd.MM.yyyy")</span>
                            <span>@selectedActivity.StartDate.ToString("HH:mm")</span>
                        </div>
                        <div class="info-item">
                            <strong>Bitiş</strong>
                            <span>@selectedActivity.EndDate.ToString("dd.MM.yyyy")</span>
                            <span>@selectedActivity.EndDate.ToString("HH:mm")</span>
                        </div>
                        <div class="info-item">
                            <strong>Kontenjan</strong>
                            <span>@(selectedActivity.NumberOfParticipants ?? 0) / @(selectedActivity.ParticipantLimit?.ToString() ?? "∞")</span>
                        </div>
                    </div>
                    <div class="modal-description">@selectedActivity.ActivityDescription</div>
                    
                    @* Katılım ve Değerlendirme Bölümü *@
                    @if (isStudent)
                    {
                        <div class="modal-actions">
                            @* Değerlendirme Yıldızları - Sadece katılımcılar için ve değerlendirme süresi içinde *@
                            @if (isParticipating && CanRate())
                            {
                                <div class="rating-section">
                                    <label class="rating-label">Etkinliği Değerlendir:</label>
                                    <div class="star-rating">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            var starValue = i;
                                            <span class="star @(starValue <= (hoverRating > 0 ? hoverRating : userRating) ? "active" : "")"
                                                  @onclick="() => SetRating(starValue)"
                                                  @onmouseover="() => hoverRating = starValue"
                                                  @onmouseout="() => hoverRating = 0">★</span>
                                        }
                                    </div>
                                    @if (isRatingProcessing)
                                    {
                                        <span class="rating-status"><span class="spinner-small"></span></span>
                                    }
                                    else if (!string.IsNullOrEmpty(ratingMessage))
                                    {
                                        <span class="rating-status @(ratingSuccess ? "success" : "error")">@ratingMessage</span>
                                    }
                                </div>
                            }
                            else if (isParticipating && !CanRate())
                            {
                                <div class="rating-section disabled">
                                    <label class="rating-label">Değerlendirme:</label>
                                    <p class="rating-info">@GetRatingStatusMessage()</p>
                                </div>
                            }

                            @* Kayıt Butonu *@
                            @if (isCheckingParticipation)
                            {
                                <button class="btn-participation loading" disabled>
                                    <span class="spinner"></span> Kontrol ediliyor...
                                </button>
                            }
                            else if (isParticipating)
                            {
                                <button class="btn-participation leave" @onclick="LeaveActivity" disabled="@isProcessing">
                                    @if (isProcessing)
                                    {
                                        <span class="spinner"></span>
                                    }
                                    Kaydı İptal Et
                                </button>
                            }
                            else
                            {
                                <button class="btn-participation join" @onclick="JoinActivity" disabled="@isProcessing">
                                    @if (isProcessing)
                                    {
                                        <span class="spinner"></span>
                                    }
                                    Etkinliğe Kayıt Ol
                                </button>
                            }
                            
                            @if (!string.IsNullOrEmpty(participationMessage))
                            {
                                <div class="participation-message @(participationSuccess ? "success" : "error")">
                                    @participationMessage
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else if (selectedAnnouncement != null)
            {
                <div class="modal-header">
                    <button class="modal-close-btn" @onclick="ClosePopup">×</button>
                    <h2 class="modal-title">@selectedAnnouncement.Title</h2>
                    <div class="modal-type-badge"></div>
                </div>
                <div class="modal-body">
                    <div class="modal-date-box">
                        <span>🕒</span>
                        <p>Yayınlanma: @selectedAnnouncement.CreatedAt.ToString("dd MMMM yyyy")</p>
                    </div>
                    <div class="modal-description extended-text">@selectedAnnouncement.Content</div>
                </div>
            }
        </div>
    </div>
}


@code {
    private List<Activity>? activities;
    private List<Activity>? recommendedActivities;
    private List<Announcement>? announcements;
    private ElementReference etkinlikListesi;
    private ElementReference oneriListesi;
    private ElementReference duyuruListesi;
    private bool isPopupVisible = false;
    private Activity? selectedActivity;
    private Announcement? selectedAnnouncement;
    
    // Katılım durumu için
    private bool isStudent = false;
    private int currentUserId = 0;
    private bool isParticipating = false;
    private bool isCheckingParticipation = false;
    private bool isProcessing = false;
    private string participationMessage = "";
    private bool participationSuccess = false;
    
    // Öneri sistemi için
    private bool isLoadingRecommendations = false;
    
    // Rating için
    private int userRating = 0;
    private int hoverRating = 0;
    private double averageRating = 0;
    private int ratingCount = 0;
    private bool isRatingProcessing = false;
    private string ratingMessage = "";
    private bool ratingSuccess = false;
    
    private string[] gradients = {
        "linear-gradient(135deg, #dc3545, #c82333)",
        "linear-gradient(135deg, #6a0080, #9b59b6)",
        "linear-gradient(135deg, #008cba, #3498db)",
        "linear-gradient(135deg, #28a745, #20c997)",
        "linear-gradient(135deg, #ffc107, #ff9800)"
    };
    private Random random = new Random();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            activities = await ActivityService.GetAllAsync();
            announcements = await AnnouncementService.GetAllAsync();
            activities = activities?.Where(a => a.IsActive && !a.IsDeleted).OrderByDescending(a => a.StartDate).ToList();
            announcements = announcements?.OrderByDescending(a => a.CreatedAt).ToList();
        }
        catch (Exception) { activities = new(); announcements = new(); }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var userType = await TokenService.GetUserTypeAsync();
            var userId = await TokenService.GetUserIdAsync();
            
            isStudent = userType == "student";
            currentUserId = userId ?? 0;
            
            // Öğrenci ise önerileri yükle
            if (isStudent && currentUserId > 0)
            {
                await LoadRecommendations();
            }
            
            StateHasChanged();
        }
    }

    private async Task LoadRecommendations()
    {
        isLoadingRecommendations = true;
        StateHasChanged();
        
        try
        {
            recommendedActivities = await RecommendationService.GetRecommendationsAsync(currentUserId);
        }
        catch (Exception)
        {
            recommendedActivities = new List<Activity>();
        }
        
        isLoadingRecommendations = false;
        StateHasChanged();
    }

    private async Task OpenActivityPopup(Activity activity)
    {
        selectedActivity = activity;
        selectedAnnouncement = null;
        isPopupVisible = true;
        participationMessage = "";
        ratingMessage = "";
        userRating = 0;
        hoverRating = 0;
        
        // Ortalama puanı al
        await LoadActivityRating();
        
        // Öğrenci ise katılım durumunu kontrol et
        if (isStudent && currentUserId > 0)
        {
            await CheckParticipationStatus();
        }
        
        StateHasChanged();
    }

    private async Task LoadActivityRating()
    {
        if (selectedActivity == null) return;
        
        var result = await ParticipationService.GetActivityRatingAsync(selectedActivity.ActivityID);
        if (result.Success)
        {
            averageRating = result.AverageRating;
            ratingCount = result.RatingCount;
        }
    }

    private async Task CheckParticipationStatus()
    {
        if (selectedActivity == null) return;
        
        isCheckingParticipation = true;
        StateHasChanged();
        
        var result = await ParticipationService.CheckParticipationAsync(selectedActivity.ActivityID, currentUserId);
        isParticipating = result.IsParticipating;
        userRating = result.CurrentRating ?? 0;
        
        isCheckingParticipation = false;
        StateHasChanged();
    }

    private bool CanRate()
    {
        if (selectedActivity == null) return false;
        var now = DateTime.UtcNow;
        return now >= selectedActivity.StartDate && now <= selectedActivity.EndDate.AddDays(1);
    }

    private string GetRatingStatusMessage()
    {
        if (selectedActivity == null) return "";
        var now = DateTime.UtcNow;
        
        if (now < selectedActivity.StartDate)
            return "Etkinlik başladıktan sonra değerlendirme yapabilirsiniz.";
        if (now > selectedActivity.EndDate.AddDays(1))
            return "Değerlendirme süresi dolmuştur.";
        return "";
    }

    private async Task SetRating(int rating)
    {
        if (selectedActivity == null || !CanRate()) return;
        
        isRatingProcessing = true;
        ratingMessage = "";
        StateHasChanged();
        
        var result = await ParticipationService.RateActivityAsync(selectedActivity.ActivityID, rating);
        
        ratingMessage = result.Message;
        ratingSuccess = result.Success;
        
        if (result.Success)
        {
            userRating = rating;
            await LoadActivityRating(); // Ortalamayı güncelle
        }
        
        isRatingProcessing = false;
        StateHasChanged();
    }

    private async Task JoinActivity()
    {
        if (selectedActivity == null) return;
        
        isProcessing = true;
        participationMessage = "";
        StateHasChanged();
        
        var result = await ParticipationService.JoinActivityAsync(selectedActivity.ActivityID);
        
        participationMessage = result.Message;
        participationSuccess = result.Success;
        
        if (result.Success)
        {
            isParticipating = true;
            selectedActivity.NumberOfParticipants = (selectedActivity.NumberOfParticipants ?? 0) + 1;
        }
        
        isProcessing = false;
        StateHasChanged();
    }

    private async Task LeaveActivity()
    {
        if (selectedActivity == null) return;
        
        isProcessing = true;
        participationMessage = "";
        StateHasChanged();
        
        var result = await ParticipationService.LeaveActivityAsync(selectedActivity.ActivityID);
        
        participationMessage = result.Message;
        participationSuccess = result.Success;
        
        if (result.Success)
        {
            isParticipating = false;
            if (selectedActivity.NumberOfParticipants > 0)
                selectedActivity.NumberOfParticipants--;
        }
        
        isProcessing = false;
        StateHasChanged();
    }

    private void OpenAnnouncementPopup(Announcement announcement) 
    { 
        selectedAnnouncement = announcement; 
        selectedActivity = null; 
        isPopupVisible = true; 
    }
    
    private void ClosePopup() 
    { 
        isPopupVisible = false; 
        selectedActivity = null; 
        selectedAnnouncement = null; 
        participationMessage = ""; 
        ratingMessage = "";
    }
    
    private string GetRandomGradient() => gradients[random.Next(gradients.Length)];

    private string GetActivityImage(string? imagePath)
    {
        if (string.IsNullOrWhiteSpace(imagePath))
            return "/Images/EtkinlikDefault.png";
        
        // API'den gelen resimler için tam URL oluştur
        if (imagePath.StartsWith("/Images/ActivityImages/"))
        {
            var apiBaseUrl = Configuration["ApiSettings:BaseUrl"] ?? "https://localhost:7077";
            return $"{apiBaseUrl}{imagePath}";
        }
        
        return imagePath;
    }

    private async Task ScrollActivityLeft() => await JSRuntime.InvokeVoidAsync("scrollElementByWidth", etkinlikListesi);
    private async Task ScrollActivityRight() => await JSRuntime.InvokeVoidAsync("scrollElementByWidth", etkinlikListesi, true);
    private async Task ScrollRecommendationsLeft() => await JSRuntime.InvokeVoidAsync("scrollElementByWidth", oneriListesi);
    private async Task ScrollRecommendationsRight() => await JSRuntime.InvokeVoidAsync("scrollElementByWidth", oneriListesi, true);
    private async Task ScrollLeft() => await JSRuntime.InvokeVoidAsync("scrollElement", duyuruListesi, -400);
    private async Task ScrollRight() => await JSRuntime.InvokeVoidAsync("scrollElement", duyuruListesi, 400);
}
