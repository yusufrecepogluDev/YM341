@page "/register"
@rendermode InteractiveServer
@using System.Security.Cryptography
@using KampusEtkinlik.Components.Layout
@using KampusEtkinlik.DTOs
@using KampusEtkinlik.Services
@using System.ComponentModel.DataAnnotations
@layout LoginLayout
@inject NavigationManager NavigationManager
@inject AuthenticationService AuthService

<style>
    body {
        display: flex;
        text-align: center;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        min-width: 100vw;
        background: linear-gradient(rgba(220, 53, 69, 0.7), rgba(139, 0, 0, 0.7)), url('/images/dudullu-yerleskesi.png');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
</style>

<div class="login-container">
    <img src="images/dogus_universitesi_yeni_logo.png" />
    <h1>KAYIT OL</h1>

    <div class="user-type-selector">
        <button class="@(isStudentRegister ? "active" : "")" @onclick="() => isStudentRegister = true">Öğrenci</button>
        <button class="@(!isStudentRegister ? "active" : "")" @onclick="() => isStudentRegister = false">Kulüp</button>
    </div>

    @if (isStudentRegister)
    {
        <EditForm Model="@studentRegisterForm" OnValidSubmit="@HandleStudentRegister">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label for="StudentNumber">Öğrenci Numarası</label>
                <InputText @bind-Value="studentRegisterForm.StudentNumberText" type="text" inputmode="numeric" id="StudentNumber" placeholder="Örn: 2021010001" />
                <ValidationMessage For="@(() => studentRegisterForm.StudentNumberText)" />
            </div>

            <div class="form-group">
                <label for="StudentName">Ad</label>
                <InputText @bind-Value="studentRegisterForm.StudentName" type="text" id="StudentName" placeholder="Adınız" />
                <ValidationMessage For="@(() => studentRegisterForm.StudentName)" />
            </div>

            <div class="form-group">
                <label for="StudentSurname">Soyad</label>
                <InputText @bind-Value="studentRegisterForm.StudentSurname" type="text" id="StudentSurname" placeholder="Soyadınız" />
                <ValidationMessage For="@(() => studentRegisterForm.StudentSurname)" />
            </div>

            <div class="form-group">
                <label for="StudentEmail">E-posta</label>
                <InputText @bind-Value="studentRegisterForm.StudentEmail" type="email" id="StudentEmail" placeholder="ornek@ogr.dogus.edu.tr" />
                <ValidationMessage For="@(() => studentRegisterForm.StudentEmail)" />
            </div>

            <div class="form-group">
                <label for="StudentPassword">Şifre</label>
                <InputText @bind-Value="studentRegisterForm.StudentPassword" type="password" id="StudentPassword" placeholder="En az 6 karakter" />
                <ValidationMessage For="@(() => studentRegisterForm.StudentPassword)" />
            </div>

            <div class="form-group">
                <label for="StudentPasswordConfirm">Şifre Tekrar</label>
                <InputText @bind-Value="studentRegisterForm.StudentPasswordConfirm" type="password" id="StudentPasswordConfirm" placeholder="Şifrenizi tekrar giriniz" />
                <ValidationMessage For="@(() => studentRegisterForm.StudentPasswordConfirm)" />
            </div>

            <div class="form-group">
                <button class="buton" type="submit" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Kayıt yapılıyor...</span>
                    }
                    else
                    {
                        <span>Kayıt Ol</span>
                    }
                </button>
            </div>
        </EditForm>
    }
    else
    {
        <EditForm Model="@clubRegisterForm" OnValidSubmit="@HandleClubRegister">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label for="ClubNumber">Kulüp Numarası</label>
                <InputText @bind-Value="clubRegisterForm.ClubNumberText" type="text" inputmode="numeric" id="ClubNumber" placeholder="Örn: 1001" />
                <ValidationMessage For="@(() => clubRegisterForm.ClubNumberText)" />
            </div>

            <div class="form-group">
                <label for="ClubName">Kulüp Adı</label>
                <InputText @bind-Value="clubRegisterForm.ClubName" type="text" id="ClubName" placeholder="Örn: Yazılım Kulübü" />
                <ValidationMessage For="@(() => clubRegisterForm.ClubName)" />
            </div>

            <div class="form-group">
                <label for="ClubDescription">Kulüp Açıklaması</label>
                <InputTextArea @bind-Value="clubRegisterForm.ClubDescription" id="ClubDescription" placeholder="Kulübünüz hakkında kısa bir açıklama yazın..." rows="1" />
                <ValidationMessage For="@(() => clubRegisterForm.ClubDescription)" />
            </div>

            <div class="form-group">
                <label for="ClubEmail">E-posta</label>
                <InputText @bind-Value="clubRegisterForm.ClubEmail" type="email" id="ClubEmail" placeholder="ornek@kulup.dogus.edu.tr" />
                <ValidationMessage For="@(() => clubRegisterForm.ClubEmail)" />
            </div>

            <div class="form-group">
                <label for="ClubPassword">Şifre</label>
                <InputText @bind-Value="clubRegisterForm.ClubPassword" type="password" id="ClubPassword" placeholder="En az 6 karakter" />
                <ValidationMessage For="@(() => clubRegisterForm.ClubPassword)" />
            </div>

            <div class="form-group">
                <label for="ClubPasswordConfirm">Şifre Tekrar</label>
                <InputText @bind-Value="clubRegisterForm.ClubPasswordConfirm" type="password" id="ClubPasswordConfirm" placeholder="Şifrenizi tekrar giriniz" />
                <ValidationMessage For="@(() => clubRegisterForm.ClubPasswordConfirm)" />
            </div>

            <div class="form-group">
                <button class="buton" type="submit" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Kayıt yapılıyor...</span>
                    }
                    else
                    {
                        <span>Kayıt Ol</span>
                    }
                </button>
            </div>
        </EditForm>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">
            @errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="success-message">
            @successMessage
        </div>
    }

    <div class="form-group" style="margin-top: 20px; text-align: right;">
        <a href="/login" style="color: #dc3545; text-decoration: none;">Zaten hesabın var mı? Giriş Yap</a>
    </div>
</div>


@code {
    private StudentRegisterForm studentRegisterForm = new();
    private ClubRegisterForm clubRegisterForm = new();
    private bool isStudentRegister = true;
    private bool isLoading = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    private async Task HandleStudentRegister()
    {
        isLoading = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        // Şifre kontrolü
        if (studentRegisterForm.StudentPassword != studentRegisterForm.StudentPasswordConfirm)
        {
            errorMessage = "Şifreler eşleşmiyor";
            isLoading = false;
            return;
        }

        // String'i long'a çevir
        if (!long.TryParse(studentRegisterForm.StudentNumberText, out long studentNumber))
        {
            errorMessage = "Geçerli bir öğrenci numarası giriniz";
            isLoading = false;
            return;
        }

        var request = new StudentRegisterRequestDto
        {
            StudentNumber = studentNumber,
            StudentName = studentRegisterForm.StudentName,
            StudentSurname = studentRegisterForm.StudentSurname,
            StudentMail = studentRegisterForm.StudentEmail,
            StudentPassword = HashPassword(studentRegisterForm.StudentPassword)
        };

        var result = await AuthService.StudentRegisterAsync(request);

        if (result.Success)
        {
            successMessage = "Kayıt başarılı! Giriş sayfasına yönlendiriliyorsunuz...";
            await Task.Delay(2000);
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            errorMessage = result.Message;
        }

        isLoading = false;
    }

    private async Task HandleClubRegister()
    {
        isLoading = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        // Şifre kontrolü
        if (clubRegisterForm.ClubPassword != clubRegisterForm.ClubPasswordConfirm)
        {
            errorMessage = "Şifreler eşleşmiyor";
            isLoading = false;
            return;
        }

        // String'i long'a çevir
        if (!long.TryParse(clubRegisterForm.ClubNumberText, out long clubNumber))
        {
            errorMessage = "Geçerli bir kulüp numarası giriniz";
            isLoading = false;
            return;
        }

        var request = new ClubRegisterRequestDto
        {
            ClubNumber = clubNumber,
            ClubName = clubRegisterForm.ClubName,
            ClubDescription = clubRegisterForm.ClubDescription,
            ClubEmail = clubRegisterForm.ClubEmail,
            ClubPassword = HashPassword(clubRegisterForm.ClubPassword)
        };

        var result = await AuthService.ClubRegisterAsync(request);

        if (result.Success)
        {
            successMessage = "Kayıt başarılı! Giriş sayfasına yönlendiriliyorsunuz...";
            await Task.Delay(2000);
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            errorMessage = result.Message;
        }

        isLoading = false;
    }

    private string HashPassword(string password)
    {
        using (SHA256 sha256 = SHA256.Create())
        {
            byte[] bytes = sha256.ComputeHash(System.Text.Encoding.UTF8.GetBytes(password));
            return Convert.ToBase64String(bytes);
        }
    }

    public class StudentRegisterForm
    {
        [Required(ErrorMessage = "Öğrenci numarası zorunludur")]
        [RegularExpression(@"^\d+$", ErrorMessage = "Sadece rakam girebilirsiniz")]
        public string StudentNumberText { get; set; } = string.Empty;

        [Required(ErrorMessage = "Ad zorunludur")]
        [MaxLength(50, ErrorMessage = "Ad en fazla 50 karakter olabilir")]
        public string StudentName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Soyad zorunludur")]
        [MaxLength(50, ErrorMessage = "Soyad en fazla 50 karakter olabilir")]
        public string StudentSurname { get; set; } = string.Empty;

        [Required(ErrorMessage = "E-posta zorunludur")]
        [EmailAddress(ErrorMessage = "Geçerli bir e-posta adresi giriniz")]
        public string StudentEmail { get; set; } = string.Empty;

        [Required(ErrorMessage = "Şifre zorunludur")]
        [MinLength(6, ErrorMessage = "Şifre en az 6 karakter olmalıdır")]
        [MaxLength(20, ErrorMessage = "Şifre en fazla 20 karakter olabilir")]
        public string StudentPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Şifre tekrarı zorunludur")]
        public string StudentPasswordConfirm { get; set; } = string.Empty;
    }

    public class ClubRegisterForm
    {
        [Required(ErrorMessage = "Kulüp numarası zorunludur")]
        [RegularExpression(@"^\d+$", ErrorMessage = "Sadece rakam girebilirsiniz")]
        public string ClubNumberText { get; set; } = string.Empty;

        [Required(ErrorMessage = "Kulüp adı zorunludur")]
        [MaxLength(100, ErrorMessage = "Kulüp adı en fazla 100 karakter olabilir")]
        public string ClubName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Kulüp açıklaması zorunludur")]
        [MaxLength(500, ErrorMessage = "Açıklama en fazla 500 karakter olabilir")]
        public string ClubDescription { get; set; } = string.Empty;

        [Required(ErrorMessage = "E-posta zorunludur")]
        [EmailAddress(ErrorMessage = "Geçerli bir e-posta adresi giriniz")]
        public string ClubEmail { get; set; } = string.Empty;

        [Required(ErrorMessage = "Şifre zorunludur")]
        [MinLength(6, ErrorMessage = "Şifre en az 6 karakter olmalıdır")]
        [MaxLength(20, ErrorMessage = "Şifre en fazla 20 karakter olabilir")]
        public string ClubPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Şifre tekrarı zorunludur")]
        public string ClubPasswordConfirm { get; set; } = string.Empty;
    }
}
