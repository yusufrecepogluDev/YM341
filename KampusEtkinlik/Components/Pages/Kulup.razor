@page "/kulup"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject ActivityService ActivityService
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@inject TokenService TokenService
@using Blazored.LocalStorage
@using KampusEtkinlik.Data.DTOs
@using KampusEtkinlik.Data.Models
@using KampusEtkinlik.Services
@using KampusEtkinlik.Components.Layout

<AuthGuard RequiredUserType="club">
    <div class="tab-menu">
        <button type="button" class="@(aktifSekme == 1 ? "active-tab" : "")" @onclick="() => aktifSekme = 1">Etkinlik Yönetimi</button>
        <button type="button" class="@(aktifSekme == 2 ? "active-tab" : "")" @onclick="() => aktifSekme = 2">Duyuru Yönetimi</button>
    </div>
    @if (aktifSekme == 1)
    {
    <div class="sayfa-cont" @onclick="() => openDropdownId = null">
    <div class="etk-cont" @onclick:stopPropagation="true">
        <h2 class="etk-title">Etkinlik Oluştur</h2>

        <EditForm FormName="ActivityCreate" Model="@model" OnValidSubmit="@CreateActivity">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label class="label-1">Etkinlik Başlığı</label>
                <InputTextArea @bind-Value="model.ActivityName" class="form-control-2"  placeholder="Etkinliği başlığını buraya girin" />
            </div>

            <div class="form-group">
                <label class="label-1">Etkinlik Açıklaması</label>
                <InputTextArea @bind-Value="model.ActivityDescription" class="form-control-2" placeholder="Etkinlik açıklamasını buraya girin"/> 
            </div>

            <div class="trh-grp">  @* tarihleri gruplandırmak için trh-grp diye class adı ekledim --Enes*@
                <div class="form-group">
                    <label>Etkinlik Başlangıç Tarihi</label>
                    <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="model.StartDate" class="form-control"  />
                </div>

                <div class="form-group">
                    <label>Etkinlik Bitiş Tarihi</label>
                    <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="model.EndDate" class="form-control" />
                </div>
            </div>

            <div class="form-group">
                <label>Etkinlik Katılımcı Sınırı</label>
                <InputNumber @bind-Value="model.ParticipantLimit" class="form-control" />
            </div>

            <div class="trh-grp"> @* Yukarıdaki ile aynı tarihler yan yana ekranda güzel dursun diye ekledim. --Enes*@
            <div class="form-group">
                <label>Etkinlik Oylama Başlangıç Tarihi</label>
                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="model.EvaluationStartDate" class="form-control" />
            </div>

            <div class="form-group">
                <label>Etkinlik Oylama Bitiş Tarihi</label>
                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="model.EvaluationEndDate" class="form-control" />
            </div>
            </div>

            <button type="submit" class="etk-btn">
                Etkinlik Oluştur
            </button>
        </EditForm>
    </div>
    <div class="etkinlikler-cont" @onclick:stopPropagation="true">
        <h2 class="etk-title-2">Etkinlikler</h2>

        @if (!string.IsNullOrEmpty(mesaj))
        {
            <div class="alert-message">@mesaj</div>
        }

        <div class="etkinlik-kart">
            @if (activities == null)
            {
                <p>Yükleniyor...</p>
            }
            else if (!activities.Any())
            {
                <p>Henüz etkinlik bulunmamaktadır.</p>
            }
            else
            {
                @foreach (var activity in activities)
                {
                    <div class="etkinlik-icerik">
                        <div class="etkinlik-text">
                            <h5 class="etkinlik-baslik">@activity.ActivityName</h5>
                            <p class="etkinlik-ozet">@activity.ActivityDescription</p>
                            <small>@activity.StartDate.ToString("dd.MM.yyyy HH:mm") - @activity.EndDate.ToString("dd.MM.yyyy HH:mm")</small>
                        </div>
                        <div class="dropdown @(openDropdownId == activity.ActivityID ? "active" : "")">
                            <button class="dropdown-btn" type="button" @onclick="() => ToggleDropdown(activity.ActivityID)" @onclick:stopPropagation="true">⋮</button>
                            <div class="dropdown-content @(openDropdownId == activity.ActivityID ? "show" : "")" @onclick:stopPropagation="true">
                                <button type="button" @onclick="() => { EditActivity(activity.ActivityID); openDropdownId = null; }">Düzenle</button>
                                <button type="button" @onclick="() => { DeleteActivity(activity.ActivityID); openDropdownId = null; }">Sil</button>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>
}
@if (aktifSekme == 2)
    {
        <div class="sayfa-cont">
            <div class="etk-cont">
                <h2 class="etk-title">Duyuru Oluştur</h2>
                
                <div class="form-group">
                    <label class="label-1">Duyuru Başlığı</label>
                    <input class="form-control" placeholder="Başlık giriniz..." />
                </div>

                <div class="form-group">
                    <label class="label-1">Duyuru İçeriği</label>
                    <textarea class="form-control-2" placeholder="Duyuru detaylarını yazın..."></textarea>
                </div>

                <button class="etk-btn">Duyuru Yayınla</button>
            </div>

            <div class="etkinlikler-cont">
                <h2 class="etk-title-2">Duyurular</h2>
                <div class="etkinlik-kart">
                    <p style="text-align:center; color:#666;">Henüz duyuru yok.</p>
                </div>
            </div>
        </div>
    }

    @* Düzenleme Popup *@
    @if (showEditModal && editingActivity != null)
    {
        <div class="modal-overlay" @onclick="CloseEditModal">
            <div class="modal-content" @onclick:stopPropagation>
                <h3>Etkinlik Düzenle</h3>

                <EditForm Model="@editModel" OnValidSubmit="@SaveEditActivity">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Etkinlik Başlığı</label>
                        <InputTextArea @bind-Value="editModel.ActivityName" class="form-control-2" />
                    </div>

                    <div class="form-group">
                        <label>Etkinlik Açıklaması</label>
                        <InputTextArea @bind-Value="editModel.ActivityDescription" class="form-control-2" />
                    </div>

                    <div class="trh-grp">
                        <div class="form-group">
                            <label>Başlangıç Tarihi</label>
                            <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editModel.StartDate" class="form-control" />
                        </div>

                        <div class="form-group">
                            <label>Bitiş Tarihi</label>
                            <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editModel.EndDate" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Katılımcı Sınırı</label>
                        <InputNumber @bind-Value="editModel.ParticipantLimit" class="form-control" />
                    </div>

                    <div class="trh-grp">
                        <div class="form-group">
                            <label>Oylama Başlangıç</label>
                            <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editModel.EvaluationStartDate" class="form-control" />
                        </div>

                        <div class="form-group">
                            <label>Oylama Bitiş</label>
                            <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editModel.EvaluationEndDate" class="form-control" />
                        </div>
                    </div>

                    <div class="modal-buttons">
                        <button type="button" class="btn-cancel" @onclick="CloseEditModal">İptal</button>
                        <button type="submit" class="btn-save">Kaydet</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    @* Silme Onay Popup *@
    @if (showDeleteModal)
    {
        <div class="modal-overlay" @onclick="CloseDeleteModal">
            <div class="modal-content" @onclick:stopPropagation style="max-width: 400px;">
                <h3>Etkinliği Sil</h3>
                <p>Bu etkinliği silmek istediğinizden emin misiniz?</p>
                <p><strong>@deletingActivityName</strong></p>

                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" @onclick="CloseDeleteModal">İptal</button>
                    <button type="button" class="btn-confirm-delete" @onclick="ConfirmDelete">Sil</button>
                </div>
            </div>
        </div>
    }
</AuthGuard>

@code {
    [SupplyParameterFromForm]
    private ActivityCreateDto model { get; set; } = new();

    private string mesaj = "";
    private int aktifSekme = 1;



    private List<Activity>? activities;
    private int currentClubId = 0;

    // Düzenleme için
    private bool showEditModal = false;
    private Activity? editingActivity = null;
    private ActivityUpdateDto editModel = new();

    // Silme için
    private bool showDeleteModal = false;
    private int deletingActivityId = 0;
    private string deletingActivityName = "";

    // Dropdown için
    private int? openDropdownId = null;

    private void ToggleDropdown(int activityId)
    {
        if (openDropdownId == activityId)
        {
            openDropdownId = null;
        }
        else
        {
            openDropdownId = activityId;
        }
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        model.StartDate = DateTime.Now;
        model.EndDate = DateTime.Now.AddDays(1);
        model.EvaluationStartDate = DateTime.Now;
        model.EvaluationEndDate = DateTime.Now.AddDays(7);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var clubId = await TokenService.GetUserIdAsync();
                System.Diagnostics.Debug.WriteLine($"Token'dan okunan ClubID: {clubId}");
                
                if (clubId.HasValue && clubId.Value > 0)
                {
                    model.OrganizingClubID = clubId.Value;
                    currentClubId = clubId.Value;
                    await LoadActivities();
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine("Kulüp bilgisi bulunamadı");
                }
                
                StateHasChanged();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Token hatası: {ex.Message}");
                model.OrganizingClubID = 0;
                StateHasChanged();
            }
        }
    }

    private async Task LoadActivities()
    {
        try
        {
            var allActivities = await ActivityService.GetAllAsync();
            
            // Silinmemiş ve bu kulübün etkinliklerini filtrele
            activities = allActivities
                .Where(a => !a.IsDeleted && a.IsActive)
                .Where(a => currentClubId <= 0 || a.OrganizingClubID == currentClubId)
                .OrderByDescending(a => a.CreationDate)
                .ToList();
                
            System.Diagnostics.Debug.WriteLine($"Toplam {allActivities.Count} etkinlik, {activities.Count} aktif etkinlik gösteriliyor");
        }
        catch (Exception ex)
        {
            mesaj = $"❌ Etkinlikler yüklenirken hata: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"LoadActivities hatası: {ex}");
            activities = new List<Activity>();
        }
    }

    private async Task CreateActivity()
    {
        // ClubID'yi tekrar kontrol et
        if (currentClubId <= 0)
        {
            try
            {
                var clubId = await TokenService.GetUserIdAsync();
                if (clubId.HasValue)
                {
                    currentClubId = clubId.Value;
                    model.OrganizingClubID = currentClubId;
                }
            }
            catch { }
        }
        
        if (model.OrganizingClubID <= 0 || currentClubId <= 0)
        {
            mesaj = $"❌ Hata: Kulüp bilgisi bulunamadı (ClubID: {currentClubId}). Lütfen önce giriş yapın.";
            System.Diagnostics.Debug.WriteLine($"CreateActivity - ClubID: {currentClubId}, model.OrganizingClubID: {model.OrganizingClubID}");
            return;
        }

        try
        {
            System.Diagnostics.Debug.WriteLine($"Etkinlik oluşturuluyor - ClubID: {model.OrganizingClubID}");
            var sonuc = await ActivityService.AddAsync(model);

            if (sonuc)
            {
                mesaj = "✅ Etkinlik başarıyla eklendi.";
                
                // Formu temizle
                model = new ActivityCreateDto
                {
                    OrganizingClubID = currentClubId,
                    StartDate = DateTime.Now,
                    EndDate = DateTime.Now.AddDays(1),
                    EvaluationStartDate = DateTime.Now,
                    EvaluationEndDate = DateTime.Now.AddDays(7)
                };
                
                // Etkinlikleri yeniden yükle
                await LoadActivities();
                StateHasChanged();
            }
            else
            {
                mesaj = "❌ API hatası oluştu.";
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"CreateActivity hatası: {ex}");
            if (ex.Message.Contains("FOREIGN KEY"))
            {
                mesaj = $"❌ Hata: Kulüp ID ({model.OrganizingClubID}) veritabanında bulunamadı.";
            }
            else
            {
                mesaj = $"❌ Hata: {ex.Message}";
            }
        }
    }

    private async Task EditActivity(int activityId)
    {
        try
        {
            editingActivity = await ActivityService.GetByIdAsync(activityId);
            
            if (editingActivity != null)
            {
                editModel = new ActivityUpdateDto
                {
                    ActivityName = editingActivity.ActivityName,
                    ActivityDescription = editingActivity.ActivityDescription,
                    StartDate = editingActivity.StartDate,
                    EndDate = editingActivity.EndDate,
                    ParticipantLimit = editingActivity.ParticipantLimit,
                    EvaluationStartDate = editingActivity.EvaluationStartDate,
                    EvaluationEndDate = editingActivity.EvaluationEndDate
                };
                
                showEditModal = true;
            }
            else
            {
                mesaj = "❌ Etkinlik bulunamadı.";
            }
        }
        catch (Exception ex)
        {
            mesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private async Task SaveEditActivity()
    {
        if (editingActivity == null) return;

        try
        {
            var sonuc = await ActivityService.UpdateAsync(editingActivity.ActivityID, editModel);
            
            if (sonuc)
            {
                mesaj = "✅ Etkinlik başarıyla güncellendi.";
                showEditModal = false;
                editingActivity = null;
                await LoadActivities();
                StateHasChanged();
            }
            else
            {
                mesaj = "❌ Etkinlik güncellenirken hata oluştu.";
            }
        }
        catch (Exception ex)
        {
            mesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingActivity = null;
    }

    private void DeleteActivity(int activityId)
    {
        var activity = activities?.FirstOrDefault(a => a.ActivityID == activityId);
        if (activity != null)
        {
            deletingActivityId = activityId;
            deletingActivityName = activity.ActivityName;
            showDeleteModal = true;
        }
    }

    private async Task ConfirmDelete()
    {
        try
        {
            var sonuc = await ActivityService.DeleteAsync(deletingActivityId);
            
            if (sonuc)
            {
                mesaj = "✅ Etkinlik başarıyla silindi.";
                showDeleteModal = false;
                deletingActivityId = 0;
                deletingActivityName = "";
                await LoadActivities();
                StateHasChanged();
            }
            else
            {
                mesaj = "❌ Etkinlik silinirken hata oluştu.";
            }
        }
        catch (Exception ex)
        {
            mesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deletingActivityId = 0;
        deletingActivityName = "";
    }
}
