@page "/kulupyonetim"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject ActivityService ActivityService
@inject AnnouncementService AnnouncementService
@inject ClubMembershipService MembershipService
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@inject TokenService TokenService
@using Blazored.LocalStorage
@using KampusEtkinlik.Data.DTOs
@using KampusEtkinlik.Data.Models
@using KampusEtkinlik.Services
@using KampusEtkinlik.Components.Layout

<AuthGuard RequiredUserType="club">

    <div class="sayfa-container-container">
        <div class="tab-menu">
            <button type="button" class="@(aktifSekme == 1 ? "active-tab" : "")" @onclick="() => aktifSekme = 1">Etkinlik Yönetimi</button>
            <button type="button" class="@(aktifSekme == 2 ? "active-tab" : "")" @onclick="() => aktifSekme = 2">Duyuru Yönetimi</button>
            <button type="button" class="@(aktifSekme == 3 ? "active-tab" : "")" @onclick="() => aktifSekme = 3">Üyelik Yönetimi</button>
        </div>
        @if (aktifSekme == 1)
        {
            <div class="sayfa-cont" @onclick="() => openDropdownId = null">
                <div class="etk-cont" @onclick:stopPropagation="true">
                    <h2 class="etk-title">Etkinlik Oluştur</h2>

                    <EditForm FormName="ActivityCreate" Model="@model" OnValidSubmit="@CreateActivity">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="form-group">
                            <label class="label-1">Etkinlik Başlığı</label>
                            <InputText @bind-Value="model.ActivityName" class="form-control" placeholder="Örn: Bahar Şenliği 2024" />
                        </div>

                        <div class="form-group">
                            <label class="label-1">Etkinlik Açıklaması</label>
                            <InputTextArea @bind-Value="model.ActivityDescription" class="form-control" placeholder="Etkinlik hakkında detaylı bilgi verin..." />
                        </div>

                        <div class="trh-grp">
                            @* tarihleri gruplandırmak için trh-grp diye class adı ekledim --Enes*@
                            <div class="form-group">
                                <label>Etkinlik Başlangıç Tarihi</label>
                                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="model.StartDate" class="form-control" />
                            </div>

                            <div class="form-group">
                                <label>Etkinlik Bitiş Tarihi</label>
                                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="model.EndDate" class="form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Etkinlik Katılımcı Sınırı</label>
                            <InputNumber @bind-Value="model.ParticipantLimit" class="form-control" />
                        </div>

                        <div class="trh-grp">
                            @* Yukarıdaki ile aynı tarihler yan yana ekranda güzel dursun diye ekledim. --Enes*@
                            <div class="form-group">
                                <label>Etkinlik Oylama Başlangıç Tarihi</label>
                                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="model.EvaluationStartDate" class="form-control" />
                            </div>

                            <div class="form-group">
                                <label>Etkinlik Oylama Bitiş Tarihi</label>
                                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="model.EvaluationEndDate" class="form-control" />
                            </div>
                        </div>

                        <button type="submit" class="etk-btn">
                            Etkinlik Oluştur
                        </button>
                    </EditForm>
                </div>
                <div class="etkinlikler-cont" @onclick:stopPropagation="true">
                    <h2 class="etk-title-2">Etkinlikler</h2>

                    @if (!string.IsNullOrEmpty(mesaj))
                    {
                        <div class="alert-message">@mesaj</div>
                    }

                    <div class="etkinlik-kart">
                        @if (activities == null)
                        {
                            <p>Yükleniyor...</p>
                        }
                        else if (!activities.Any())
                        {
                            <p>Henüz etkinlik bulunmamaktadır.</p>
                        }
                        else
                        {
                            @foreach (var activity in activities)
                            {
                                <div class="etkinlik-icerik">
                                    <div class="etkinlik-text">
                                        <h5 class="etkinlik-baslik">@activity.ActivityName</h5>
                                        <p class="etkinlik-ozet">@activity.ActivityDescription</p>
                                        <small>@activity.StartDate.ToString("dd.MM.yyyy HH:mm") - @activity.EndDate.ToString("dd.MM.yyyy HH:mm")</small>
                                    </div>
                                    <div class="dropdown @(openDropdownId == activity.ActivityID ? "active" : "")">
                                        <button class="dropdown-btn" type="button" @onclick="() => ToggleDropdown(activity.ActivityID)" @onclick:stopPropagation="true">⋮</button>
                                        <div class="dropdown-content @(openDropdownId == activity.ActivityID ? "show" : "")" @onclick:stopPropagation="true">
                                            <button type="button" @onclick="() => { EditActivity(activity.ActivityID); openDropdownId = null; }">Düzenle</button>
                                            <button type="button" @onclick="() => { DeleteActivity(activity.ActivityID); openDropdownId = null; }">Sil</button>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        }
        @if (aktifSekme == 2)
        {
            <div class="sayfa-cont" @onclick="() => openAnnouncementDropdownId = null">
                <div class="etk-cont" @onclick:stopPropagation="true">
                    <h2 class="etk-title">Duyuru Oluştur</h2>

                    <EditForm FormName="AnnouncementCreate" Model="@announcementModel" OnValidSubmit="@CreateAnnouncement">
                        <div class="form-group">
                            <label class="label-1">Duyuru Başlığı</label>
                            <InputText @bind-Value="announcementModel.AnnouncementTitle" class="form-control" placeholder="Örn: Toplantı Duyurusu" />
                        </div>

                        <div class="form-group">
                            <label class="label-1">Duyuru İçeriği</label>
                            <InputTextArea @bind-Value="announcementModel.AnnouncementContent" class="form-control" placeholder="Duyurunuzun detaylarını buraya yazın..."></InputTextArea>
                        </div>

                        <button type="submit" class="etk-btn">Duyuru Yayınla</button>
                    </EditForm>
                </div>

                <div class="etkinlikler-cont" @onclick:stopPropagation="true">
                    <h2 class="etk-title-2">Duyurular</h2>

                    @if (!string.IsNullOrEmpty(announcementMesaj))
                    {
                        <div class="alert-message">@announcementMesaj</div>
                    }

                    <div class="etkinlik-kart">
                        @if (announcements == null)
                        {
                            <p>Yükleniyor...</p>
                        }
                        else if (!announcements.Any())
                        {
                            <p style="text-align:center; color:#666;">Henüz duyuru yok.</p>
                        }
                        else
                        {
                            @foreach (var announcement in announcements)
                            {
                                <div class="etkinlik-icerik">
                                    <div class="etkinlik-text">
                                        <h5 class="etkinlik-baslik">@announcement.AnnouncementTitle</h5>
                                        <p class="etkinlik-ozet">@announcement.AnnouncementContent</p>
                                        <small>@announcement.StartDate.ToString("dd.MM.yyyy HH:mm")</small>
                                    </div>
                                    <div class="dropdown @(openAnnouncementDropdownId == announcement.AnnouncementID ? "active" : "")">
                                        <button class="dropdown-btn" type="button" @onclick="() => ToggleAnnouncementDropdown(announcement.AnnouncementID)" @onclick:stopPropagation="true">⋮</button>
                                        <div class="dropdown-content @(openAnnouncementDropdownId == announcement.AnnouncementID ? "show" : "")" @onclick:stopPropagation="true">
                                            <button type="button" @onclick="() => { EditAnnouncement(announcement.AnnouncementID); openAnnouncementDropdownId = null; }">Düzenle</button>
                                            <button type="button" @onclick="() => { DeleteAnnouncement(announcement.AnnouncementID); openAnnouncementDropdownId = null; }">Sil</button>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        }
        @if (aktifSekme == 3)
        {
            <div class="sayfa-cont">
                <div class="uyelik-cont">
                    <h2 class="etk-title">Bekleyen Başvurular</h2>

                    @if (!string.IsNullOrEmpty(membershipMesaj))
                    {
                        <div class="alert-message @(membershipMesaj.Contains("❌") ? "alert-error" : "")">@membershipMesaj</div>
                    }

                    <div class="uyelik-liste">
                        @if (pendingApplications == null)
                        {
                            <p class="loading-text">Yükleniyor...</p>
                        }
                        else if (!pendingApplications.Any())
                        {
                            <div class="empty-state">
                                <span class="empty-icon">📭</span>
                                <p>Bekleyen başvuru bulunmamaktadır.</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var application in pendingApplications)
                            {
                                <div class="uyelik-kart">
                                    <div class="uyelik-bilgi">
                                        <div class="uyelik-avatar">@application.StudentName?.FirstOrDefault()</div>
                                        <div class="uyelik-detay">
                                            <h4>@application.StudentName</h4>
                                            <p>@application.StudentEmail</p>
                                            <small>Başvuru: @application.JoinDate?.ToString("dd.MM.yyyy HH:mm")</small>
                                        </div>
                                    </div>
                                    <div class="uyelik-aksiyonlar">
                                        <button class="btn-onayla" @onclick="() => ApproveApplication(application.MembershipID)">
                                            ✓ Onayla
                                        </button>
                                        <button class="btn-reddet" @onclick="() => RejectApplication(application.MembershipID)">
                                            ✕ Reddet
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="uyelik-cont">
                    <h2 class="etk-title-2">Mevcut Üyeler</h2>

                    <div class="uyelik-liste">
                        @if (approvedMembers == null)
                        {
                            <p class="loading-text">Yükleniyor...</p>
                        }
                        else if (!approvedMembers.Any())
                        {
                            <div class="empty-state">
                                <span class="empty-icon">👥</span>
                                <p>Henüz onaylanmış üye bulunmamaktadır.</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var member in approvedMembers)
                            {
                                <div class="uyelik-kart uye-kart">
                                    <div class="uyelik-bilgi">
                                        <div class="uyelik-avatar approved">@member.StudentName?.FirstOrDefault()</div>
                                        <div class="uyelik-detay">
                                            <h4>@member.StudentName</h4>
                                            <p>@member.StudentEmail</p>
                                            <small>Üyelik: @member.JoinDate?.ToString("dd.MM.yyyy")</small>
                                        </div>
                                    </div>
                                    <div class="uyelik-aksiyonlar">
                                        <button class="btn-cikar" @onclick="() => RemoveMember(member.MembershipID, member.StudentName)">
                                            Üyelikten Çıkar
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        }

        @* Üye Çıkarma Onay Popup *@
        @if (showRemoveMemberModal)
        {
            <div class="modal-overlay" @onclick="CloseRemoveMemberModal">
                <div class="modal-content" @onclick:stopPropagation style="max-width: 400px;">
                    <h3>Üyeyi Çıkar</h3>
                    <p>Bu üyeyi kulüpten çıkarmak istediğinizden emin misiniz?</p>
                    <p><strong>@removingMemberName</strong></p>

                    <div class="modal-buttons">
                        <button type="button" class="btn-cancel" @onclick="CloseRemoveMemberModal">İptal</button>
                        <button type="button" class="btn-confirm-delete" @onclick="ConfirmRemoveMember">Çıkar</button>
                    </div>
                </div>
            </div>
        }

        @* Düzenleme Popup *@
        @if (showEditModal && editingActivity != null)
        {
            <div class="modal-overlay" @onclick="CloseEditModal">
                <div class="modal-content" @onclick:stopPropagation>
                    <h3>Etkinlik Düzenle</h3>

                    <EditForm Model="@editModel" OnValidSubmit="@SaveEditActivity">
                        <DataAnnotationsValidator />

                        <div class="form-group">
                            <label>Etkinlik Başlığı</label>
                            <InputText @bind-Value="editModel.ActivityName" class="form-control" placeholder="Etkinlik başlığı" />
                        </div>

                        <div class="form-group">
                            <label>Etkinlik Açıklaması</label>
                            <InputTextArea @bind-Value="editModel.ActivityDescription" class="form-control-2" placeholder="Etkinlik açıklaması" />
                        </div>

                        <div class="trh-grp">
                            <div class="form-group">
                                <label>Başlangıç Tarihi</label>
                                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editModel.StartDate" class="form-control" />
                            </div>

                            <div class="form-group">
                                <label>Bitiş Tarihi</label>
                                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editModel.EndDate" class="form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Katılımcı Sınırı</label>
                            <InputNumber @bind-Value="editModel.ParticipantLimit" class="form-control" />
                        </div>

                        <div class="trh-grp">
                            <div class="form-group">
                                <label>Oylama Başlangıç</label>
                                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editModel.EvaluationStartDate" class="form-control" />
                            </div>

                            <div class="form-group">
                                <label>Oylama Bitiş</label>
                                <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editModel.EvaluationEndDate" class="form-control" />
                            </div>
                        </div>

                        <div class="modal-buttons">
                            <button type="button" class="btn-cancel" @onclick="CloseEditModal">İptal</button>
                            <button type="submit" class="btn-save">Kaydet</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }

        @* Silme Onay Popup *@
        @if (showDeleteModal)
        {
            <div class="modal-overlay" @onclick="CloseDeleteModal">
                <div class="modal-content" @onclick:stopPropagation style="max-width: 400px;">
                    <h3>Etkinliği Sil</h3>
                    <p>Bu etkinliği silmek istediğinizden emin misiniz?</p>
                    <p><strong>@deletingActivityName</strong></p>

                    <div class="modal-buttons">
                        <button type="button" class="btn-cancel" @onclick="CloseDeleteModal">İptal</button>
                        <button type="button" class="btn-confirm-delete" @onclick="ConfirmDelete">Sil</button>
                    </div>
                </div>
            </div>
        }

        @* Duyuru Düzenleme Popup *@
        @if (showEditAnnouncementModal && editingAnnouncement != null)
        {
            <div class="modal-overlay" @onclick="CloseEditAnnouncementModal">
                <div class="modal-content" @onclick:stopPropagation>
                    <h3>Duyuru Düzenle</h3>

                    <EditForm Model="@editAnnouncementModel" OnValidSubmit="@SaveEditAnnouncement">
                        <div class="form-group">
                            <label>Duyuru Başlığı</label>
                            <InputText @bind-Value="editAnnouncementModel.AnnouncementTitle" class="form-control" placeholder="Duyuru başlığı" />
                        </div>

                        <div class="form-group">
                            <label>Duyuru İçeriği</label>
                            <InputTextArea @bind-Value="editAnnouncementModel.AnnouncementContent" class="form-control-2" placeholder="Duyuru içeriği" />
                        </div>

                        <div class="modal-buttons">
                            <button type="button" class="btn-cancel" @onclick="CloseEditAnnouncementModal">İptal</button>
                            <button type="submit" class="btn-save">Kaydet</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }

        @* Duyuru Silme Onay Popup *@
        @if (showDeleteAnnouncementModal)
        {
            <div class="modal-overlay" @onclick="CloseDeleteAnnouncementModal">
                <div class="modal-content" @onclick:stopPropagation style="max-width: 400px;">
                    <h3>Duyuruyu Sil</h3>
                    <p>Bu duyuruyu silmek istediğinizden emin misiniz?</p>
                    <p><strong>@deletingAnnouncementTitle</strong></p>

                    <div class="modal-buttons">
                        <button type="button" class="btn-cancel" @onclick="CloseDeleteAnnouncementModal">İptal</button>
                        <button type="button" class="btn-confirm-delete" @onclick="ConfirmDeleteAnnouncement">Sil</button>
                    </div>
                </div>
            </div>

        }
    </div>
</AuthGuard>

@code {
    [SupplyParameterFromForm]
    private ActivityCreateDto model { get; set; } = new();

    private string mesaj = "";
    private int aktifSekme = 1;

    private List<Activity>? activities;
    private int currentClubId = 0;

    // Düzenleme için
    private bool showEditModal = false;
    private Activity? editingActivity = null;
    private ActivityUpdateDto editModel = new();

    // Silme için
    private bool showDeleteModal = false;
    private int deletingActivityId = 0;
    private string deletingActivityName = "";

    // Dropdown için
    private int? openDropdownId = null;

    // Duyuru yönetimi için
    [SupplyParameterFromForm]
    private AnnouncementCreateDto announcementModel { get; set; } = new();
    private string announcementMesaj = "";
    private List<Announcement>? announcements;

    // Duyuru düzenleme için
    private bool showEditAnnouncementModal = false;
    private Announcement? editingAnnouncement = null;
    private Announcement editAnnouncementModel = new();

    // Duyuru silme için
    private bool showDeleteAnnouncementModal = false;
    private int deletingAnnouncementId = 0;
    private string deletingAnnouncementTitle = "";

    // Duyuru dropdown için
    private int? openAnnouncementDropdownId = null;

    // Üyelik yönetimi için
    private List<Services.ClubMembershipResponseDto>? pendingApplications;
    private List<Services.ClubMembershipResponseDto>? approvedMembers;
    private string membershipMesaj = "";

    // Üye çıkarma için
    private bool showRemoveMemberModal = false;
    private int removingMemberId = 0;
    private string removingMemberName = "";

    private void ToggleDropdown(int activityId)
    {
        if (openDropdownId == activityId)
        {
            openDropdownId = null;
        }
        else
        {
            openDropdownId = activityId;
        }
        StateHasChanged();
    }

    private void ToggleAnnouncementDropdown(int announcementId)
    {
        if (openAnnouncementDropdownId == announcementId)
        {
            openAnnouncementDropdownId = null;
        }
        else
        {
            openAnnouncementDropdownId = announcementId;
        }
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        model.StartDate = DateTime.Now;
        model.EndDate = DateTime.Now.AddDays(1);
        model.EvaluationStartDate = DateTime.Now;
        model.EvaluationEndDate = DateTime.Now.AddDays(7);

        announcementModel.StartDate = DateTime.Now;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var clubId = await TokenService.GetUserIdAsync();
                System.Diagnostics.Debug.WriteLine($"Token'dan okunan ClubID: {clubId}");

                if (clubId.HasValue && clubId.Value > 0)
                {
                    model.OrganizingClubID = clubId.Value;
                    currentClubId = clubId.Value;
                    announcementModel.ClubID = clubId.Value;
                    await LoadActivities();
                    await LoadAnnouncements();
                    await LoadMemberships();
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine("Kulüp bilgisi bulunamadı");
                }

                StateHasChanged();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Token hatası: {ex.Message}");
                model.OrganizingClubID = 0;
                StateHasChanged();
            }
        }
    }

    private async Task LoadActivities()
    {
        try
        {
            var allActivities = await ActivityService.GetAllAsync();

            // Silinmemiş ve bu kulübün etkinliklerini filtrele
            activities = allActivities
                .Where(a => !a.IsDeleted && a.IsActive)
                .Where(a => currentClubId <= 0 || a.OrganizingClubID == currentClubId)
                .OrderByDescending(a => a.CreationDate)
                .ToList();

            System.Diagnostics.Debug.WriteLine($"Toplam {allActivities.Count} etkinlik, {activities.Count} aktif etkinlik gösteriliyor");
        }
        catch (Exception ex)
        {
            mesaj = $"❌ Etkinlikler yüklenirken hata: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"LoadActivities hatası: {ex}");
            activities = new List<Activity>();
        }
    }

    private async Task CreateActivity()
    {
        // ClubID'yi tekrar kontrol et
        if (currentClubId <= 0)
        {
            try
            {
                var clubId = await TokenService.GetUserIdAsync();
                if (clubId.HasValue)
                {
                    currentClubId = clubId.Value;
                    model.OrganizingClubID = currentClubId;
                }
            }
            catch { }
        }

        if (model.OrganizingClubID <= 0 || currentClubId <= 0)
        {
            mesaj = $"❌ Hata: Kulüp bilgisi bulunamadı (ClubID: {currentClubId}). Lütfen önce giriş yapın.";
            System.Diagnostics.Debug.WriteLine($"CreateActivity - ClubID: {currentClubId}, model.OrganizingClubID: {model.OrganizingClubID}");
            return;
        }

        try
        {
            System.Diagnostics.Debug.WriteLine($"Etkinlik oluşturuluyor - ClubID: {model.OrganizingClubID}");
            var sonuc = await ActivityService.AddAsync(model);

            if (sonuc)
            {
                mesaj = "✅ Etkinlik başarıyla eklendi.";

                // Formu temizle
                model = new ActivityCreateDto
                {
                    OrganizingClubID = currentClubId,
                    StartDate = DateTime.Now,
                    EndDate = DateTime.Now.AddDays(1),
                    EvaluationStartDate = DateTime.Now,
                    EvaluationEndDate = DateTime.Now.AddDays(7)
                };

                // Etkinlikleri yeniden yükle
                await LoadActivities();
                StateHasChanged();
            }
            else
            {
                mesaj = "❌ API hatası oluştu.";
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"CreateActivity hatası: {ex}");
            if (ex.Message.Contains("FOREIGN KEY"))
            {
                mesaj = $"❌ Hata: Kulüp ID ({model.OrganizingClubID}) veritabanında bulunamadı.";
            }
            else
            {
                mesaj = $"❌ Hata: {ex.Message}";
            }
        }
    }

    private async Task EditActivity(int activityId)
    {
        try
        {
            editingActivity = await ActivityService.GetByIdAsync(activityId);

            if (editingActivity != null)
            {
                editModel = new ActivityUpdateDto
                {
                    ActivityName = editingActivity.ActivityName,
                    ActivityDescription = editingActivity.ActivityDescription,
                    StartDate = editingActivity.StartDate,
                    EndDate = editingActivity.EndDate,
                    ParticipantLimit = editingActivity.ParticipantLimit,
                    EvaluationStartDate = editingActivity.EvaluationStartDate,
                    EvaluationEndDate = editingActivity.EvaluationEndDate
                };

                showEditModal = true;
            }
            else
            {
                mesaj = "❌ Etkinlik bulunamadı.";
            }
        }
        catch (Exception ex)
        {
            mesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private async Task SaveEditActivity()
    {
        if (editingActivity == null) return;

        try
        {
            var sonuc = await ActivityService.UpdateAsync(editingActivity.ActivityID, editModel);

            if (sonuc)
            {
                mesaj = "✅ Etkinlik başarıyla güncellendi.";
                showEditModal = false;
                editingActivity = null;
                await LoadActivities();
                StateHasChanged();
            }
            else
            {
                mesaj = "❌ Etkinlik güncellenirken hata oluştu.";
            }
        }
        catch (Exception ex)
        {
            mesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingActivity = null;
    }

    private void DeleteActivity(int activityId)
    {
        var activity = activities?.FirstOrDefault(a => a.ActivityID == activityId);
        if (activity != null)
        {
            deletingActivityId = activityId;
            deletingActivityName = activity.ActivityName;
            showDeleteModal = true;
        }
    }

    private async Task ConfirmDelete()
    {
        try
        {
            var sonuc = await ActivityService.DeleteAsync(deletingActivityId);

            if (sonuc)
            {
                mesaj = "✅ Etkinlik başarıyla silindi.";
                showDeleteModal = false;
                deletingActivityId = 0;
                deletingActivityName = "";
                await LoadActivities();
                StateHasChanged();
            }
            else
            {
                mesaj = "❌ Etkinlik silinirken hata oluştu.";
            }
        }
        catch (Exception ex)
        {
            mesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deletingActivityId = 0;
        deletingActivityName = "";
    }

    // Duyuru yönetimi fonksiyonları
    private async Task LoadAnnouncements()
    {
        try
        {
            var allAnnouncements = await AnnouncementService.GetAllAsync();

            announcements = allAnnouncements
                .Where(a => !a.IsDeleted && a.IsActive)
                .Where(a => currentClubId <= 0 || a.ClubID == currentClubId)
                .OrderByDescending(a => a.StartDate)
                .ToList();

            System.Diagnostics.Debug.WriteLine($"Toplam {allAnnouncements.Count} duyuru, {announcements.Count} aktif duyuru gösteriliyor");
        }
        catch (Exception ex)
        {
            announcementMesaj = $"❌ Duyurular yüklenirken hata: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"LoadAnnouncements hatası: {ex}");
            announcements = new List<Announcement>();
        }
    }

    private async Task CreateAnnouncement()
    {
        if (currentClubId <= 0)
        {
            try
            {
                var clubId = await TokenService.GetUserIdAsync();
                if (clubId.HasValue)
                {
                    currentClubId = clubId.Value;
                    announcementModel.ClubID = currentClubId;
                }
            }
            catch { }
        }

        if (announcementModel.ClubID <= 0 || currentClubId <= 0)
        {
            announcementMesaj = $"❌ Hata: Kulüp bilgisi bulunamadı. Lütfen önce giriş yapın.";
            return;
        }

        try
        {
            announcementModel.StartDate = DateTime.Now;

            var sonuc = await AnnouncementService.AddAsync(announcementModel);

            if (sonuc)
            {
                announcementMesaj = "✅ Duyuru başarıyla yayınlandı.";

                announcementModel = new AnnouncementCreateDto
                {
                    ClubID = currentClubId,
                    StartDate = DateTime.Now
                };

                await LoadAnnouncements();
                StateHasChanged();
            }
            else
            {
                announcementMesaj = "❌ API hatası oluştu.";
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"CreateAnnouncement hatası: {ex}");
            announcementMesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private async Task EditAnnouncement(int announcementId)
    {
        try
        {
            editingAnnouncement = await AnnouncementService.GetByIdAsync(announcementId);

            if (editingAnnouncement != null)
            {
                editAnnouncementModel = new Announcement
                {
                    AnnouncementID = editingAnnouncement.AnnouncementID,
                    AnnouncementTitle = editingAnnouncement.AnnouncementTitle,
                    AnnouncementContent = editingAnnouncement.AnnouncementContent,
                    ClubID = editingAnnouncement.ClubID,
                    StartDate = editingAnnouncement.StartDate,
                    IsActive = editingAnnouncement.IsActive,
                    IsDeleted = editingAnnouncement.IsDeleted,
                    CreationDate = editingAnnouncement.CreationDate
                };

                showEditAnnouncementModal = true;
            }
            else
            {
                announcementMesaj = "❌ Duyuru bulunamadı.";
            }
        }
        catch (Exception ex)
        {
            announcementMesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private async Task SaveEditAnnouncement()
    {
        if (editingAnnouncement == null) return;

        try
        {
            var sonuc = await AnnouncementService.UpdateAsync(editingAnnouncement.AnnouncementID, editAnnouncementModel);

            if (sonuc)
            {
                announcementMesaj = "✅ Duyuru başarıyla güncellendi.";
                showEditAnnouncementModal = false;
                editingAnnouncement = null;
                await LoadAnnouncements();
                StateHasChanged();
            }
            else
            {
                announcementMesaj = "❌ Duyuru güncellenirken hata oluştu.";
            }
        }
        catch (Exception ex)
        {
            announcementMesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private void CloseEditAnnouncementModal()
    {
        showEditAnnouncementModal = false;
        editingAnnouncement = null;
    }

    private void DeleteAnnouncement(int announcementId)
    {
        var announcement = announcements?.FirstOrDefault(a => a.AnnouncementID == announcementId);
        if (announcement != null)
        {
            deletingAnnouncementId = announcementId;
            deletingAnnouncementTitle = announcement.AnnouncementTitle;
            showDeleteAnnouncementModal = true;
        }
    }

    private async Task ConfirmDeleteAnnouncement()
    {
        try
        {
            var sonuc = await AnnouncementService.DeleteAsync(deletingAnnouncementId);

            if (sonuc)
            {
                announcementMesaj = "✅ Duyuru başarıyla silindi.";
                showDeleteAnnouncementModal = false;
                deletingAnnouncementId = 0;
                deletingAnnouncementTitle = "";
                await LoadAnnouncements();
                StateHasChanged();
            }
            else
            {
                announcementMesaj = "❌ Duyuru silinirken hata oluştu.";
            }
        }
        catch (Exception ex)
        {
            announcementMesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private void CloseDeleteAnnouncementModal()
    {
        showDeleteAnnouncementModal = false;
        deletingAnnouncementId = 0;
        deletingAnnouncementTitle = "";
    }

    // Üyelik yönetimi fonksiyonları
    private async Task LoadMemberships()
    {
        try
        {
            pendingApplications = await MembershipService.GetPendingApplicationsAsync(currentClubId);
            approvedMembers = await MembershipService.GetClubMembersAsync(currentClubId);
            System.Diagnostics.Debug.WriteLine($"Bekleyen: {pendingApplications?.Count ?? 0}, Onaylı: {approvedMembers?.Count ?? 0}");
        }
        catch (Exception ex)
        {
            membershipMesaj = $"❌ Üyelikler yüklenirken hata: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"LoadMemberships hatası: {ex}");
            pendingApplications = new List<Services.ClubMembershipResponseDto>();
            approvedMembers = new List<Services.ClubMembershipResponseDto>();
        }
    }

    private async Task ApproveApplication(int membershipId)
    {
        try
        {
            var (success, message) = await MembershipService.ApproveApplicationAsync(membershipId);
            membershipMesaj = success ? $"✅ {message}" : $"❌ {message}";

            if (success)
            {
                await LoadMemberships();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            membershipMesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private async Task RejectApplication(int membershipId)
    {
        try
        {
            var (success, message) = await MembershipService.RejectApplicationAsync(membershipId);
            membershipMesaj = success ? $"✅ {message}" : $"❌ {message}";

            if (success)
            {
                await LoadMemberships();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            membershipMesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private void RemoveMember(int membershipId, string? memberName)
    {
        removingMemberId = membershipId;
        removingMemberName = memberName ?? "Bilinmeyen Üye";
        showRemoveMemberModal = true;
    }

    private async Task ConfirmRemoveMember()
    {
        try
        {
            var (success, message) = await MembershipService.LeaveMembershipAsync(removingMemberId);
            membershipMesaj = success ? $"✅ {message}" : $"❌ {message}";

            showRemoveMemberModal = false;
            removingMemberId = 0;
            removingMemberName = "";

            if (success)
            {
                await LoadMemberships();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            membershipMesaj = $"❌ Hata: {ex.Message}";
        }
    }

    private void CloseRemoveMemberModal()
    {
        showRemoveMemberModal = false;
        removingMemberId = 0;
        removingMemberName = "";
    }
}
