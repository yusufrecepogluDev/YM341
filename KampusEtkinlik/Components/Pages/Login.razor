@page "/"
@page "/login"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using System.Security.Cryptography
@using KampusEtkinlik.Components.Layout
@using KampusEtkinlik.DTOs
@using KampusEtkinlik.Services
@using System.ComponentModel.DataAnnotations
@using Blazored.LocalStorage
@layout LoginLayout
@inject NavigationManager NavigationManager
@inject AuthenticationService AuthService
@inject ILocalStorageService LocalStorage
@inject TokenService TokenService

<style>
/* Kırmızı-Beyaz Tema */
body {
    display: flex;
    text-align: center;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    min-width: 100vw;
    background: linear-gradient(rgba(220, 53, 69, 0.7), rgba(139, 0, 0, 0.7)), url('/images/dudullu-yerleskesi.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
}
</style>
<div class="login-container">
    <img style="max-height: 150px; max-width: 150px" src="images/dogus_universitesi_yeni_logo.png" />
    <h1>SİSTEME GİRİŞ</h1>

    <div class="user-type-selector">
        <button class="@(isStudentLogin ? "active" : "")" @onclick="() => isStudentLogin = true">Öğrenci</button>
        <button class="@(!isStudentLogin ? "active" : "")" @onclick="() => isStudentLogin = false">Kulüp</button>
    </div>

    @if (isStudentLogin)
    {
        <EditForm Model="@studentLoginForm" OnValidSubmit="@HandleStudentLogin">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label for="StudentNumber">Öğrenci Numarası</label>
                <InputText @bind-Value="studentLoginForm.StudentNumberText" type="text" inputmode="numeric" id="StudentNumber" placeholder="Okul Numaranızı Girin" />
                <ValidationMessage For="@(() => studentLoginForm.StudentNumberText)" />
            </div>

            <div class="form-group">
                <label for="StudentPassword">Şifre</label>
                <InputText @bind-Value="studentLoginForm.StudentPassword" type="password" id="StudentPassword" placeholder="Şifrenizi Girin" />
                <ValidationMessage For="@(() => studentLoginForm.StudentPassword)" />
            </div>

            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <label class="remember-me" style="margin: 0;">
                    <InputCheckbox @bind-Value="rememberMeStudent" />
                    <span>Beni Hatırla</span>
                </label>
                <NavLink class="register-link" href="/register">Öğrenci Kayıt</NavLink>
            </div>

            <div class="form-group">
                <button class="buton" type="submit" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Giriş yapılıyor...</span>
                    }
                    else
                    {
                        <span>Giriş Yap</span>
                    }
                </button>
            </div>
        </EditForm>
    }
    else
    {
        <EditForm Model="@clubLoginForm" OnValidSubmit="@HandleClubLogin">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label for="ClubNumber">Kulüp Numarası</label>
                <InputText @bind-Value="clubLoginForm.ClubNumberText" type="text" inputmode="numeric" id="ClubNumber" placeholder="Kulüp Numaranızı Girin" />
                <ValidationMessage For="@(() => clubLoginForm.ClubNumberText)" />
            </div>

            <div class="form-group">
                <label for="ClubPassword">Şifre</label>
                <InputText @bind-Value="clubLoginForm.ClubPassword" type="password" id="ClubPassword" placeholder="Şifrenizi Girin" />
                <ValidationMessage For="@(() => clubLoginForm.ClubPassword)" />
            </div>

            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <label class="remember-me" style="margin: 0;">
                    <InputCheckbox @bind-Value="rememberMeClub" />
                    <span>Beni Hatırla</span>
                </label>
                <NavLink class="register-link" href="/register">Kulüp Kayıt</NavLink>
            </div>

            <div class="form-group">
                <button class="buton" type="submit" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Giriş yapılıyor...</span>
                    }
                    else
                    {
                        <span>Giriş Yap</span>
                    }
                </button>
            </div>

            
                
            
        </EditForm>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">
            @errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="success-message">
            @successMessage
        </div>
    }
</div>

@code {
    private StudentLoginForm studentLoginForm = new();
    private ClubLoginForm clubLoginForm = new();
    private bool isStudentLogin = true;
    private bool isLoading = false;
    private bool rememberMeStudent = false;
    private bool rememberMeClub = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Eğer zaten login olmuşsa ilgili sayfaya yönlendir
            var isAuthenticated = await TokenService.IsAuthenticatedAsync();
            if (isAuthenticated)
            {
                var userType = await TokenService.GetUserTypeAsync();
                if (userType == "student")
                {
                    NavigationManager.NavigateTo("/home");
                    return;
                }
                else if (userType == "club")
                {
                    NavigationManager.NavigateTo("/kulup");
                    return;
                }
            }
            
            // İlk render'dan sonra kaydedilmiş bilgileri yükle
            await LoadRememberedCredentials();
        }
    }

    private async Task LoadRememberedCredentials()
    {
        try
        {
            // Öğrenci numarasını yükle (sadece numara, şifre değil)
            var savedStudentNumber = await LocalStorage.GetItemAsync<string>("rememberedStudentNumber");
            if (!string.IsNullOrEmpty(savedStudentNumber))
            {
                studentLoginForm.StudentNumberText = savedStudentNumber;
                rememberMeStudent = true;
                StateHasChanged();
            }

            // Kulüp numarasını yükle (sadece numara, şifre değil)
            var savedClubNumber = await LocalStorage.GetItemAsync<string>("rememberedClubNumber");
            if (!string.IsNullOrEmpty(savedClubNumber))
            {
                clubLoginForm.ClubNumberText = savedClubNumber;
                rememberMeClub = true;
                StateHasChanged();
            }
        }
        catch
        {
            // LocalStorage hatası olursa sessizce devam et
        }
    }

    private async Task HandleStudentLogin()
    {
        isLoading = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        // String'i long'a çevir
        if (!long.TryParse(studentLoginForm.StudentNumberText, out long studentNumber))
        {
            errorMessage = "Geçerli bir öğrenci numarası giriniz";
            isLoading = false;
            return;
        }

        var request = new StudentLoginRequestDto
        {
            StudentNumber = studentNumber,
            StudentPassword = HashPassword(studentLoginForm.StudentPassword)
        };

        var result = await AuthService.StudentLoginAsync(request);

        if (result.Success && result.Data != null)
        {
            // Token'ı kaydet
            await TokenService.SaveTokenAsync(result.Data.Token, "student", result.Data.StudentID);
            
            // Beni hatırla seçiliyse sadece kullanıcı numarasını kaydet (şifre değil!)
            if (rememberMeStudent)
            {
                await LocalStorage.SetItemAsync("rememberedStudentNumber", studentLoginForm.StudentNumberText);
            }
            else
            {
                await LocalStorage.RemoveItemAsync("rememberedStudentNumber");
            }

            successMessage = $"Hoş geldin {result.Data.StudentName} {result.Data.StudentSurname}!";
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/home");
        }
        else
        {
            errorMessage = result.Message;
        }

        isLoading = false;
    }

    private async Task HandleClubLogin()
    {
        isLoading = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        // String'i long'a çevir
        if (!long.TryParse(clubLoginForm.ClubNumberText, out long clubNumber))
        {
            errorMessage = "Geçerli bir kulüp numarası giriniz";
            isLoading = false;
            return;
        }

        var request = new ClubLoginRequestDto
        {
            ClubNumber = clubNumber,
            ClubPassword = HashPassword(clubLoginForm.ClubPassword)
        };

        var result = await AuthService.ClubLoginAsync(request);

        if (result.Success && result.Data != null)
        {
            // Token'ı kaydet
            await TokenService.SaveTokenAsync(result.Data.Token, "club", result.Data.ClubID);
            
            // Beni hatırla seçiliyse sadece kulüp numarasını kaydet (şifre değil!)
            if (rememberMeClub)
            {
                await LocalStorage.SetItemAsync("rememberedClubNumber", clubLoginForm.ClubNumberText);
            }
            else
            {
                await LocalStorage.RemoveItemAsync("rememberedClubNumber");
            }

            successMessage = $"Hoş geldin {result.Data.ClubName}!";
            
            // Token'ın kaydedildiğinden emin olmak için kısa bir bekleme
            await Task.Delay(500);
            
            // Yönlendirmeden önce token'ı doğrula
            var savedUserType = await TokenService.GetUserTypeAsync();
            System.Diagnostics.Debug.WriteLine($"Login - Saved userType: '{savedUserType}'");
            
            await Task.Delay(500);
            NavigationManager.NavigateTo("/kulup");
        }
        else
        {
            errorMessage = result.Message;
        }

        isLoading = false;
    }

    private string HashPassword(string password)
    {
        using (SHA256 sha256 = SHA256.Create())
        {
            byte[] bytes = sha256.ComputeHash(System.Text.Encoding.UTF8.GetBytes(password));
            return Convert.ToBase64String(bytes);
        }
    }

    public class StudentLoginForm
    {
        [Required(ErrorMessage = "Öğrenci numarası zorunludur")]
        [RegularExpression(@"^\d+$", ErrorMessage = "Sadece rakam girebilirsiniz")]
        public string StudentNumberText { get; set; } = string.Empty;

        [Required(ErrorMessage = "Şifre zorunludur")]
        [MaxLength(20, ErrorMessage = "Şifre en fazla 20 karakter olabilir")]
        public string StudentPassword { get; set; } = string.Empty;
    }

    public class ClubLoginForm
    {
        [Required(ErrorMessage = "Kulüp numarası zorunludur")]
        [RegularExpression(@"^\d+$", ErrorMessage = "Sadece rakam girebilirsiniz")]
        public string ClubNumberText { get; set; } = string.Empty;

        [Required(ErrorMessage = "Şifre zorunludur")]
        [MaxLength(20, ErrorMessage = "Şifre en fazla 20 karakter olabilir")]
        public string ClubPassword { get; set; } = string.Empty;
    }
}